<html xmlns:e="http://exam.extension.io" xmlns:cc="http://www.concordion.org/2007/concordion">
<body>
<h1>Getting started</h1>
<e:summary/>
<e:given>
    We have a simple CRUD App for widgets manipulation.
    Widgets are stored in DB like this:
    <e:db-show table="WIDGETS"/>
</e:given>
<h3>Let's test widget creation API:</h3>
<e:example name="Successful widget creation" print="true">
    <e:given>
        <e:db-set caption="There are no widgets" table="widgets"/>
    </e:given>
    <e:post url="/widgets">
        <e:case desc="Successful creation">
            <e:body>{"name" : "widget1", "quantity": "10"}</e:body>
            <e:expected statusCode="201" reasonPhrase="Created">
                {
                "id": "{{number}}",
                "name": "widget1",
                "quantity": 10,
                "updatedAt": "{{formattedAndWithinNow "yyyy-MM-dd'T'HH:mm:ss.SSSXXX" "5s"}}"
                }
            </e:expected>
            <e:check>
                <e:db-check caption="Widget was created:" table="widgets" cols="id, name, quantity, updated" orderBy="name">
                    <e:row>!{regex}\d, widget1, 10, !{within 5s}</e:row>
                </e:db-check>
            </e:check>
        </e:case>
    </e:post>
</e:example>
<e:example name="Invalid creation" print="true">
    <e:given>
        <e:db-set caption="There are no widgets" table="widgets"/>
    </e:given>
    <e:post url="/widgets">
        <e:case desc="name is required">
            <e:body>{"quantity": "10"}</e:body>
            <e:expected statusCode="400" reasonPhrase="Bad Request">{ "error": "name is required" }</e:expected>
        </e:case>
        <e:case desc="quantity is required">
            <e:body>{"name": "widget1"}</e:body>
            <e:expected statusCode="400" reasonPhrase="Bad Request">{ "error": "quantity is required" }</e:expected>
        </e:case>
        <e:check>
            <e:db-check caption="No widgets were created:" table="widgets"/>
        </e:check>
    </e:post>
</e:example>
<h3>Let's test widget deletion API:</h3>
<e:example name="Successful widget deletion" print="true">
    <e:given>
        <e:db-set caption="Given widget:" table="widgets" cols="name, quantity, id=1, updated={{now}}">
            <e:row>widget1, 10</e:row>
        </e:db-set>
    </e:given>
    <e:delete url="/widgets/1">
        <e:case desc="Successful deletion">
            <e:expected>{"result" : "ok"}</e:expected>
            <e:check>
                <e:db-check caption="Widget was deleted:" table="widgets"/>
            </e:check>
        </e:case>
        <e:case desc="Absent widget deletion">
            <e:expected statusCode="404" reasonPhrase="Not Found">{"result" : "error"}</e:expected>
        </e:case>
    </e:delete>
</e:example>
<h3>Let's test widget retrieving API:</h3>
<e:example name="Successful widget retrieving" print="true">
    <e:given>
        <e:set var="upd1" value="{{now tz='GMT+3'}}"/>
        <e:set var="upd2" value="{{now plus='1 day'}}"/>
        <e:set var="format" value="yyyy-MM-dd'T'HH:mm:ss.SSSXXX"/>
        <e:db-set caption="Given widgets:" table="widgets" cols="name, quantity, updated, id=1..3">
            <e:row>widget1, 10, {{upd1}}</e:row>
            <e:row>widget2, 20, {{upd2}}</e:row>
            <e:row>widget3, 30, {{date '01.02.2000 10:20' format="dd.MM.yyyy HH:mm"}}</e:row>
        </e:db-set>
    </e:given>
    <e:get url="/widgets">
        <e:case desc="Can retrieve stored widgets">
            <e:expected>
                [{
                "id": 1,
                "name": "widget1",
                "quantity": 10,
                "updatedAt": "{{dateFormat upd1 format}}"
                }, {
                "id": 2,
                "name": "widget2",
                "quantity": 20,
                "updatedAt": "{{dateFormat upd2 format}}"
                }, {
                "id": 3,
                "name": "widget3",
                "quantity": 30,
                "updatedAt": "2000-02-01T10:20:00.000+03:00"
                }]
            </e:expected>
        </e:case>
    </e:get>
</e:example>
<br/>
<h3>CRUD:</h3>
<e:example name="CRUD" print="true">
    <e:given><e:db-set caption="Given no widgets:" table="widgets" /></e:given>
    <e:post url="/widgets">
        <e:case desc="Create">
            <e:body>{"name" : "widget1", "quantity": "10"}</e:body>
            <e:expected statusCode="201" reasonPhrase="Created">
                {
                "id": "{{number}}",
                "name": "widget1",
                "quantity": 10,
                "updatedAt": "{{string}}"
                }
            </e:expected>
        </e:case>
    </e:post>
    <e:then>
        <e:set var="id" value="{{responseBody 'id'}}"/>
        <e:set var="updatedAt" value="{{responseBody 'updatedAt'}}"/>
        Widget has id = <code cc:echo="#id"/> and updatedAt = <code cc:echo="#updatedAt"/>
    </e:then>
    <e:get url="/widgets">
        <e:case desc="Read">
            <e:expected>
                [{ "id": {{id}}, "name": "widget1", "quantity": 10, "updatedAt": "{{updatedAt}}" }]
            </e:expected>
        </e:case>
    </e:get>
    <e:put url="/widgets">
        <e:case desc="Update">
            <e:body>{"id": {{id}}, "name": "new name", "quantity": "0"}</e:body>
            <e:expected>
                { "id": {{id}}, "name": "new name", "quantity": 0, "updatedAt": "{{formattedAndWithinNow "yyyy-MM-dd'T'HH:mm:ss.SSSXXX" "5s"}}" }
            </e:expected>
        </e:case>
    </e:put>
    <e:delete url="/widgets/{{id}}">
        <e:case desc="Delete">
            <e:expected>
                <e:expected>{"result" : "ok"}</e:expected>
            </e:expected>
        </e:case>
    </e:delete>
</e:example>
</body>
</html>